language: none

env:
  global:
    - JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF-8
    - secure: A6NC8VSXTXP4URXSw+99opjZw3B+BjXN/nZKDw85Kq0enE8+k8jr8nPXO6LE751aFLFfgW0El1j87bgUqEC5Tqxu61fW8HynWk0qoDv9RgIkkHqxBscIaw7bRw24Km9GDXggAUju5RnCqGXcTiMEWdBB3nWPynrh4e63dkr2mh45ijeRK72l8lCzT8Iu+Y/2/3JBqHmi7Bj/HtO/GSsZcl4PX4uXP9tNX1PXO0TdJ1+MZQrdwGxjCuagEHmz21YQxi/d+tcOwmgWYCmfvms0NzQB7vM8OGot8fymW6wuG3fG3gsrdtoZTzaFQ/HBe6pHLvHem2YRT4BsUjUqvKk28g== 

build:
    pre_ci_boot:
        image_name: agssl123/vscodeextension
        image_tag: latest
        pull: true
        options: "-e HOME=/root"

    before_script:
        - mkdir -p shippable/testresults
        - ln -s ./server/target/scala-2.12/scoverage-report shippable/testresults

    ci:
        - cd server/
        - sbt compile
        - sbt coverage test
        - sbt coverageReport
        - sbt assembly
        - java -jar './target/scala-2.12/OPAL Command Server-assembly-0.1.0-SNAPSHOT.jar' & 
        - cd ..
        - cd extension
        - npm install
        - npm run postinstall
        - "export DISPLAY=:99.0"
        - xvfb-run --server-args="-ac" npm test
        - cd ..
    on_success:
      - cp './server/target/scala-2.12/OPAL Command Server-assembly-0.1.0-SNAPSHOT.jar' ./extension/
      - vsce package
      - curl -X POST "https://alexgssl1337:$PW@api.bitbucket.org/2.0/repositories/delors/opal-vscode-explorer/downloads" --form files=@"./java-bytecode-workbench-0.1.17.vsix"
integrations:
  notifications:
    - integrationName: email
      type: email
      recipients:
        - alexandergoessl@web.de
      sendFailingSnippet: true
      on_success: change
      on_failure: always
      on_cancel: never
      on_start: never
      on_pull_request: always